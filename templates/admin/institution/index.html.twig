{% extends 'base.html.twig' %}

{% block title %}Schulverwaltung{% endblock %}

{% block body %}
    {% include 'admin/_tabs.html.twig' with {'activeTab': 'institutions'} %}

    <div class="container-fluid">

    <table class="table table-striped mt-4">
        <thead>
            <tr>
                <th>Name der Schule</th>
                <th>Ort</th>
                <th>Registrar (Admin)</th>
                <th>E-Mail</th>
                <th>User-Anzahl</th>
            </tr>
        </thead>
        <tbody>
            {% for institution in institutions %}
                <tr>
                    <td><strong>{{ institution.name }}</strong></td>
                    <td>{{ institution.city|default('N/A') }}</td>
                    <td>
                        {# Wir suchen den ersten Admin der Schule raus #}
                        {% set admin = null %}
                        {% for user in institution.users %}
                            {% if 'ROLE_ADMIN' in user.roles and admin is null %}
                                {% set admin = user %}
                            {% endif %}
                        {% endfor %}

                        {% if admin %}
                            {{ admin.firstname }} {{ admin.lastname }}
                        {% else %}
                            <span class="text-muted">Kein Admin gefunden</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if admin %}
                            <a href="mailto:{{ admin.email }}">{{ admin.email }}</a>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge bg-info text-dark">
                            {{ institution.users|length }} User
                        </span>
                    </td>
                    <td class="text-end pe-4">
                        <div class="btn-group">
                            {# Dein vorhandener Edit-Button #}
                            <a href="{{ path('admin_institution_settings', {'id': institution.id}) }}" 
                            class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-pencil-alt"></i>
                            </a>

                            {# Der neue Lösch-Button #}
                            <form method="post" action="{{ path('admin_institution_delete', {'id': institution.id}) }}" 
                                style="display:inline-block" 
                                onsubmit="return confirm('Sind Sie sicher? Alle Daten dieser Schule werden unwiderruflich gelöscht!');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ institution.id) }}">
                                <button class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="5">Noch keine Schulen registriert.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}