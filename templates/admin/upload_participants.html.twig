{% extends "base.html.twig" %}

{% block title %}Teilnehmerdaten hochladen{% endblock %}

{% block body %}
<div class="container-fluid">
    <h1 class="h3 mb-4">Teilnehmerdaten importieren</h1>

    {% include 'admin/_tabs.html.twig' with {'activeTab': 'participants_upload'} %}

    {# --- Erfolgsmeldung --- #}
    {% if message %}
        <div class="alert alert-success alert-dismissible fade show mt-3">
            <strong><i class="fas fa-check-circle"></i> Erfolg!</strong> {{ message }}<br>
            <div class="mt-2">
                <span class="badge bg-success">{{ imported|default(0) }} importiert / aktualisiert</span>
                {% if skipped is defined and skipped > 0 %}
                    <span class="badge bg-warning text-dark">{{ skipped }} übersprungen</span>
                {% endif %}
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}

    {# --- Fehlermeldung Allgemein --- #}
    {% if error %}
        <div class="alert alert-danger mt-3">
            <i class="fas fa-exclamation-triangle"></i> {{ error }}
        </div>
    {% endif %}

    {# --- Detailliertes Fehlerprotokoll --- #}
    {% if detailedErrors is defined and detailedErrors is not empty %}
        <div class="alert alert-warning mt-3">
            <h4 class="alert-heading h6"><i class="fas fa-info-circle"></i> Details zu übersprungenen Zeilen ({{ skipped }}):</h4>
            <div class="bg-white p-2 rounded border" style="max-height: 300px; overflow-y: auto; font-size: 0.9em;">
                <ul class="mb-0 ps-3">
                    {% for err in detailedErrors %}
                        <li class="text-danger">{{ err }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}

    <div class="card mt-4 shadow border-left-primary">
        <div class="card-header py-3 bg-light">
            <h6 class="m-0 font-weight-bold text-primary"> CSV-Datei hochladen</h6>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                
                <div class="row">
                    <div class="col-md-7">
                        <h5 class="small font-weight-bold text-uppercase text-gray-500 mb-3">1. Import-Modus wählen</h5>
                        
                        {# Gruppe: IServ Integration #}
                        <div class="card mb-3 border-left-info">
                            <div class="card-body py-2">
                                <h6 class="text-info fw-bold mb-2">IServ Integration (Schüler/Lehrer)</h6>
                                <p class="small text-muted mb-2">Daten (Name, Vorname) werden live aus der IServ-Datenbank geholt.</p>
                                
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="strategy" id="strat_import" value="import_id" checked>
                                    <label class="form-check-label" for="strat_import">
                                        Abgleich über <strong>Import-ID</strong> (Standard)
                                    </label>
                                    <div class="text-muted small ms-2">
                                        <i class="fas fa-table"></i> Spalten: <code>Import-ID; Geschlecht (m/w); Geburtsdatum</code>
                                    </div>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="strategy" id="strat_act" value="act">
                                    <label class="form-check-label" for="strat_act">
                                        Abgleich über <strong>IServ-Account</strong>
                                    </label>
                                    <div class="text-muted small ms-2">
                                        <i class="fas fa-table"></i> Spalten: <code>account.name; Geschlecht; Geburtsdatum</code>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# Gruppe: Standalone / Externe #}
                        <div class="card mb-3 border-left-warning">
                            <div class="card-body py-2">
                                <h6 class="text-warning fw-bold mb-2">Externe / Standalone</h6>
                                <p class="small text-muted mb-2">Für Personen, die <strong>nicht</strong> im IServ sind (oder für reine Offline-Nutzung). Namen müssen in der CSV stehen.</p>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="strategy" id="strat_standalone" value="standalone">
                                    <label class="form-check-label" for="strat_standalone">
                                        <strong>Vollständiger Import</strong> (inkl. Namen)
                                    </label>
                                    <div class="text-muted small ms-2">
                                        <i class="fas fa-table"></i> Spalten: <code>ID; Geschlecht; Datum; <strong>Vorname; Nachname</strong></code>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <h5 class="small font-weight-bold text-uppercase text-gray-500 mb-3">2. Datei wählen</h5>
                        
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">CSV-Datei (.csv)</label>
                            <input type="file" name="csvFile" id="csvFile" class="form-control" accept=".csv" required>
                            <div class="form-text">
                                Trennzeichen: Semikolon (;) oder Komma (,)<br>
                                Datumsformat: TT.MM.JJJJ oder JJJJ-MM-TT
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-file-import me-2"></i> Import starten
                            </button>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>
{% endblock %}