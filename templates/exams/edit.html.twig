{% extends "base.html.twig" %}

{% block page_title %}{{ 'Prüfung bearbeiten'|trans }}{% endblock %}

{% block body %}
    <div class="content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{{ path('app_exams_dashboard') }}" class="btn btn-osa-secondary">
                {{ icon('arrow-left') }} {{ 'Zurück zur Übersicht'|trans }}
            </a>
        </div>

        <h2 class="osa-title">{{ 'Prüfung bearbeiten'|trans }}: {{ exam.name }}</h2>

        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-osa-{{ label == 'error' ? 'danger' : 'success' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        <div class="row">
            {# --- Stammdaten --- #}
            <div class="col-lg-5 mb-4">
                <div class="card osa-card h-100">
                    <div class="card-header osa-card-header">
                        {{ icon('pencil') }} {{ 'Stammdaten'|trans }}
                    </div>
                    <div class="card-body">
                        <form method="post">
                            <div class="mb-3">
                                <label class="form-label fw-bold">{{ 'Bezeichnung'|trans }}</label>
                                <input type="text" name="exam_name" class="form-control osa-input" value="{{ exam.name }}">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">{{ 'Jahr'|trans }} *</label>
                                    <input type="number" name="exam_year" class="form-control osa-input" required value="{{ exam.year }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">{{ 'Datum'|trans }}</label>
                                    <input type="date" name="exam_date" class="form-control osa-input" value="{{ exam.date }}">
                                </div>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-osa-primary">{{ icon('floppy-disk') }} {{ 'Speichern'|trans }}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            {# --- Gruppen verwalten (NEU: Multiple Select) --- #}
            <div class="col-lg-7 mb-4">
                <div class="card osa-card h-100">
                    <div class="card-header osa-card-header-info">
                        {{ icon('group') }} {{ 'Gruppenverwaltung'|trans }}
                    </div>
                    <div class="card-body">
                        <h6 class="fw-bold">{{ 'Zugeordnete Gruppen'|trans }}</h6>
                        <div class="mb-4 osa-scroll-area">
                            {% if assigned_groups is not empty %}
                                <div class="list-group list-group-flush">
                                    {% for grp in assigned_groups %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <div>
                                                <span class="osa-text-blue fw-bold">{{ grp.name }}</span>
                                                <small class="text-muted d-block">{{ grp.act }}</small>
                                            </div>
                                            <form method="post" onsubmit="return confirm('{{ 'Entfernen?'|trans }}');">
                                                <input type="hidden" name="remove_group" value="{{ grp.act }}">
                                                <button type="submit" class="btn btn-sm btn-link text-danger p-0">
                                                    {{ icon('trash') }} {{ 'Entfernen'|trans }}
                                                </button>
                                            </form>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted small italic">{{ 'Noch keine Gruppen zugeordnet.'|trans }}</p>
                            {% endif %}
                        </div>

                        <hr class="osa-hr">

                        <form method="post">
                            <label class="form-label fw-bold">{{ 'Neue Gruppen hinzufügen'|trans }}</label>
                            <p class="small text-muted mb-2">
                                {{ 'Nur Gruppen, die im Jahr'|trans }} {{ exam.year }} {{ 'noch in keiner anderen Prüfung sind.'|trans }}
                            </p>
                            <select name="group_ids[]" class="form-select osa-select-multiple mb-3" multiple size="6">
                                {% for id, name in available_groups %}
                                    <option value="{{ id }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                            <input type="hidden" name="add_groups" value="1">
                            <button type="submit" class="btn btn-osa-success w-100" {% if available_groups is empty %}disabled{% endif %}>
                                {{ icon('plus') }} {{ 'Ausgewählte Gruppen hinzufügen'|trans }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {# ... Teil 3 (Teilnehmer) bleibt strukturell gleich, erhält aber die osa-Klassen ... #}
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {# CSP-konformes CSS über Klassen #}
    <style>
        .osa-title { color: #1a4a7a; font-weight: 700; border-bottom: 3px solid #e7f0f7; padding-bottom: 10px; margin-bottom: 25px; }
        .osa-card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 8px; }
        .osa-card-header { background-color: #1a4a7a; color: white; font-weight: 600; border-radius: 8px 8px 0 0 !important; }
        .osa-card-header-info { background-color: #517fa4; color: white; font-weight: 600; border-radius: 8px 8px 0 0 !important; }
        .osa-input:focus, .osa-select-multiple:focus { border-color: #1a4a7a; box-shadow: 0 0 0 0.25 row rgba(26, 74, 122, 0.25); }
        .btn-osa-primary { background-color: #1a4a7a; border-color: #1a4a7a; color: white; }
        .btn-osa-primary:hover { background-color: #133659; color: white; }
        .btn-osa-secondary { background-color: #6c757d; color: white; }
        .btn-osa-success { background-color: #28a745; color: white; border-radius: 20px; font-weight: 600; }
        .osa-scroll-area { max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 4px; }
        .osa-text-blue { color: #1a4a7a; }
        .osa-hr { border-top: 2px solid #e7f0f7; }
        .alert-osa-success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .osa-select-multiple { border: 2px solid #e7f0f7; }
    </style>
{% endblock %}