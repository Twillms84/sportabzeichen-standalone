{% extends 'base.html.twig' %}

{% block title %}Mein Sportabzeichen {{ year }}{% endblock %}

{# CSS einbinden (Wichtig für CSP) #}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/dashboard_css.css') }}">
{% endblock %}

{% block body %}
{% set unitMap = {'UNIT_METERS': 'm', 'UNIT_CENTIMETERS': 'cm', 'UNIT_SECONDS': 's', 'UNIT_MINUTES': 'min', 'UNIT_HOURS': 'Std.', 'UNIT_NUMBER': 'x', 'UNIT_PIECES': 'Stk.'} %}

{# --- BERECHNUNG GESAMTSTATUS --- #}
{% set totalPoints = 0 %}
{% set completedCategoriesCount = 0 %}
{% for catName, disciplines in categories %}
    {% set catDone = false %}
    {% for row in disciplines %}
        {% if row.official_result and row.official_result.points > 0 and not catDone %}
            {% set totalPoints = totalPoints + row.official_result.points %}
            {% set completedCategoriesCount = completedCategoriesCount + 1 %}
            {% set catDone = true %}
        {% endif %}
    {% endfor %}
{% endfor %}

<div class="container py-4">
    {# --- TOP SUMMARY CARD --- #}
    <div class="medal-progress-container shadow-sm border-start border-4 border-success">
        <div class="row align-items-center g-3">
            <div class="col-md-6">
                <h1 class="h3 fw-bold mb-1 text-osa-green">Sportabzeichen {{ year }}</h1>
                <p class="text-muted small mb-0">
                    AK {{ age }} | {{ (participant_sex|default('MALE')) == 'FEMALE' ? 'Weiblich' : 'Männlich' }}
                </p>
            </div>
            <div class="col-md-6 d-flex justify-content-md-end gap-3">
                {# Schwimm-Badge #}
                <div class="status-badge {% if swim_valid %}bg-success-subtle{% else %}bg-danger-subtle{% endif %}">
                    <span class="x-small fw-bold text-uppercase">Schwimmen</span>
                    <span class="fw-bold">
                        {% if swim_valid %}
                            <i class="fas fa-check-circle me-1"></i>{{ swim_valid_until }}
                        {% else %}
                            <i class="fas fa-times-circle me-1"></i>Fehlt
                        {% endif %}
                    </span>
                </div>
                {# Punkte-Badge #}
                <div class="status-badge bg-light border">
                    <span class="x-small fw-bold text-uppercase text-muted">Punkte</span>
                    <span class="h4 mb-0 fw-bold text-osa-green">{{ totalPoints }}</span>
                </div>
            </div>
        </div>
    </div>

    {# --- KATEGORIEN --- #}
    {% for catName, disciplines in categories %}
        <section class="mb-5">
            <h3 class="h5 fw-bold mb-3 text-uppercase tracking-wider text-muted">
                <i class="fas fa-layer-group me-2 text-osa-green"></i>{{ catName }}
            </h3>
            
            <div class="row g-3">
                {% for row in disciplines %}
                    {% set has_off = row.official_result is not empty %}
                    {% set has_tra = row.training_value is not empty %}
                    {% set is_done = has_off and row.official_result.points > 0 %}
                    {% set unit = unitMap[row.einheit]|default('') %}

                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 exam-card border-0">
                            {# Header mit Medaillen-Farbe bei Erfolg #}
                            <div class="card-header border-0 py-3 d-flex justify-content-between align-items-center 
                                {% if is_done %}bg-osa-green{% else %}bg-secondary{% endif %}">
                                <span class="fw-bold text-white">{{ row.name }}</span>
                                {% if is_done %}<i class="fas fa-certificate text-white"></i>{% endif %}
                            </div>

                            <div class="card-body">
                                {# Anforderungen #}
                                <div class="requirement-box mb-4">
                                    <div class="flex-fill">
                                        <small class="text-muted d-block x-small">Bronze</small>
                                        <b class="color-bronze">{{ row.bronze }}</b>
                                    </div>
                                    <div class="flex-fill border-start border-end">
                                        <small class="text-muted d-block x-small">Silber</small>
                                        <b class="color-silver">{{ row.silber }}</b>
                                    </div>
                                    <div class="flex-fill">
                                        <small class="text-muted d-block x-small">Gold</small>
                                        <b class="color-gold">{{ row.gold }}</b>
                                    </div>
                                </div>

                                {# Offizielles Ergebnis #}
                                <div class="result-box-official text-center {% if not has_off %}opacity-50 bg-light{% endif %}">
                                    <small class="text-uppercase fw-bold text-muted d-block x-small mb-1">Prüfer-Ergebnis</small>
                                    {% if has_off %}
                                        <div class="h3 mb-0 fw-bold">{{ row.official_result.leistung }} <small class="h6">{{ unit }}</small></div>
                                        <div class="mt-1">
                                            {% if row.official_result.points > 0 %}
                                                {% for i in 1..row.official_result.points %}
                                                    <i class="fas fa-medal text-warning"></i>
                                                {% endfor %}
                                                <span class="small fw-bold">{{ row.official_result.points }} Pkt.</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div class="h4 mb-0 text-muted">--</div>
                                    {% endif %}
                                </div>

                                {# Training #}
                                <div class="result-box-training text-center">
                                    <small class="text-muted text-uppercase d-block x-small">Dein Training</small>
                                    <span class="fw-bold {% if has_tra %}text-primary{% else %}text-muted opacity-50{% endif %}">
                                        {% if has_tra %}
                                            <i class="fas fa-running me-1"></i>{{ row.training_value }} {{ unit }}
                                        {% else %}
                                            Kein Eintrag
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="card-footer border-0">
                                <a href="{{ path('training_detail', { disciplineId: row.discipline_id }) }}" class="btn btn-sm btn-outline-secondary w-100">
                                    Details & Historie
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endfor %}
</div>
{% endblock %}