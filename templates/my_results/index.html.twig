{% extends 'base.html.twig' %}

{% block title %}Mein Sportabzeichen {{ year }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/dashboard_css.css') }}">
{% endblock %}

{% block body %}
{% set unitMap = {'UNIT_METERS': 'm', 'UNIT_CENTIMETERS': 'cm', 'UNIT_SECONDS': 's', 'UNIT_MINUTES': 'min', 'UNIT_HOURS': 'Std.', 'UNIT_NUMBER': 'x', 'UNIT_PIECES': 'Stk.'} %}

{# --- 1. LOGIK: STATUS & ÜBERSETZUNG --- #}
{% set totalPoints = 0 %}
{% set catStatus = {'Ausdauer': false, 'Kraft': false, 'Schnelligkeit': false, 'Koordination': false} %}

{% for catName, disciplines in categories %}
    {% set catDone = false %}
    {% for row in disciplines %}
        {% if row.official_result and row.official_result.points > 0 and not catDone %}
            {% set totalPoints = totalPoints + row.official_result.points %}
            {% set catStatus = catStatus|merge({(catName): true}) %}
            {% set catDone = true %}
        {% endif %}
    {% endfor %}
{% endfor %}

{% set isFullComplete = (catStatus['Ausdauer'] and catStatus['Kraft'] and catStatus['Schnelligkeit'] and catStatus['Koordination'] and swim_valid) %}

{# Medaillen-Typ auf Deutsch #}
{% set medalType = 'KEINES' %}
{% if isFullComplete %}
    {% if totalPoints >= 11 %}{% set medalType = 'GOLD' %}
    {% elseif totalPoints >= 8 %}{% set medalType = 'SILBER' %}
    {% else %}{% set medalType = 'BRONZE' %}{% endif %}
{% endif %}

<div class="container py-4">
    {# --- TOP SUMMARY CARD --- #}
    <div class="medal-progress-container shadow-sm border-start border-4 {% if isFullComplete %}border-success{% else %}border-warning{% endif %}">
        <div class="row align-items-center g-3">
            
            {# Medaille & Titel #}
            <div class="col-md-6 d-flex align-items-center">
                <div class="total-medal-display me-4">
                    {% if medalType != 'KEINES' %}
                        <i class="fas fa-award medal-main color-{{ medalType|lower }}"></i>
                        <span class="medal-text color-{{ medalType|lower }}">{{ medalType }}</span>
                    {% else %}
                        <i class="fas fa-medal medal-main text-muted opacity-25"></i>
                        <span class="medal-text text-muted small">In Arbeit</span>
                    {% endif %}
                </div>
                <div>
                    <h1 class="h3 fw-bold mb-1 text-osa-green">Sportabzeichen {{ year }}</h1>
                    <p class="text-muted small mb-3">AK {{ age }} | {{ (participant_sex|default('MALE')) == 'FEMALE' ? 'Weiblich' : 'Männlich' }}</p>
                    
                    <div class="d-flex flex-wrap gap-2">
                        {% for name, done in catStatus %}
                            <div class="category-status-item {% if done %}is-complete shadow-sm{% else %}opacity-50{% endif %}">
                                <i class="fas {% if done %}fa-check-circle{% else %}fa-circle-notch{% endif %}"></i>
                                {{ name }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# Badges #}
            <div class="col-md-6 d-flex justify-content-md-end gap-3 align-items-center">
                <div class="status-badge {% if swim_valid %}bg-success-subtle border-success{% else %}bg-danger-subtle border-danger{% endif %} shadow-sm text-center">
                    <span class="x-small fw-bold text-uppercase">Schwimm-Nachweis</span>
                    <span class="fw-bold d-block">
                        {% if swim_valid %}
                            <i class="fas fa-swimmer me-1"></i>GÜLTIG
                        {% else %}
                            <i class="fas fa-times-circle me-1"></i>FEHLT
                        {% endif %}
                    </span>
                    {% if swim_valid %}<small class="x-small opacity-75">bis {{ swim_valid_until }}</small>{% endif %}
                </div>

                <div class="status-badge bg-osa-green shadow-sm border-0 text-center">
                    <span class="x-small fw-bold text-uppercase text-white-50">Gesamtpunkte</span>
                    <div class="d-flex align-items-baseline justify-content-center">
                        <span class="h2 mb-0 fw-bold text-white">{{ totalPoints }}</span>
                        <span class="ms-1 text-white-50 small">/ 12</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# --- KATEGORIEN LISTE MIT COLLAPSE --- #}
    {% for catName, disciplines in categories %}
        {% set collapseId = 'collapse' ~ loop.index %}
        <section class="mb-3">
            {# Klickbare Überschrift: aria-expanded="false" signalisiert "geschlossen" #}
            <div class="category-header shadow-sm mb-1" 
                 data-bs-toggle="collapse" 
                 data-bs-target="#{{ collapseId }}" 
                 aria-expanded="false" 
                 aria-controls="{{ collapseId }}">
                
                <h3 class="h6 fw-bold mb-0 text-uppercase tracking-wider">
                    <i class="fas fa-layer-group me-2 text-osa-green"></i>
                    {{ catName }} 
                    <span class="ms-2 badge rounded-pill bg-light text-muted fw-normal" style="font-size: 0.6rem;">
                        {{ disciplines|length }} Disziplinen
                    </span>
                </h3>
                
                <div class="d-flex align-items-center">
                    {# Kleiner Status-Indikator: Zeigt an, ob in dieser Kat. schon was erledigt ist #}
                    {% if catStatus[catName] %}
                        <i class="fas fa-check-circle text-success me-3"></i>
                    {% endif %}
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
            </div>
            
            {# Einklappbarer Bereich: Ohne die Klasse "show", damit es zu Beginn zu ist #}
            <div class="collapse" id="{{ collapseId }}">
                <div class="row g-3 py-3 px-1">
                    {% for row in disciplines %}
                        {# ... (Hier bleibt dein Card-Inhalt exakt gleich wie im vorigen Schritt) ... #}
                        <div class="col-md-6 col-lg-4">
                            {# Deine Cards... #}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    {% endfor %}
                </div>
            </div>
        </section>
    {% endfor %}
</div>
{% endblock %}