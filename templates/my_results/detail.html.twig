{% extends 'base.html.twig' %}

{% block stylesheets %}
    {# Parent beh√§lt FontAwesome und Bootstrap bei #}
    {{ parent() }} 
    <link rel="stylesheet" href="{{ asset('styles/results.css') }}">
{% endblock %}

{% block title %}Ergebnisse ‚Äì {{ exam.name }}{% endblock %}

{% block body %}
{% set unitMap = {'UNIT_METERS': 'm', 'UNIT_CENTIMETERS': 'cm', 'UNIT_SECONDS': 'Sek.', 'UNIT_MINUTES': 'Min.', 'UNIT_HOURS': 'Std.', 'UNIT_NUMBER': 'Anz.', 'UNIT_PIECES': 'Wert', 'NONE': 'Verband', 'UNIT_NONE': 'Verband'} %}

<div class="container-fluid px-0 px-2 mt-3 public-wrapper">

    <div class="filter-toolbar mb-2 d-flex align-items-center w-100 px-2 flex-wrap">
        
    {# A) ANSICHT FILTER #}
    <div class="dropdown d-inline-block ms-2">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle theme-text" 
                type="button" 
                id="viewFilterBtn" 
                data-bs-toggle="dropdown" 
                data-bs-auto-close="outside" 
                aria-expanded="false">
            Disziplin
        </button>
        <ul class="dropdown-menu p-3 theme-card theme-border shadow" aria-labelledby="viewFilterBtn" style="min-width: 250px;">
            <div class="d-flex justify-content-between mb-2">
                <button class="btn btn-sm btn-link text-decoration-none js-view-all">Alle</button>
                <button class="btn btn-sm btn-link text-decoration-none js-view-none">Keine</button>
            </div>
            <div id="view-checkbox-container" style="max-height: 300px; overflow-y: auto;"></div>
        </ul>
    </div>

    {# B) GRUPPEN FILTER #}
    <div class="dropdown d-inline-block ms-2">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle theme-text" 
                type="button" 
                id="groupFilterBtn"
                data-bs-toggle="dropdown" 
                data-bs-auto-close="outside" 
                aria-expanded="false">
            Gruppen/Klassen
        </button>
        
        <ul class="dropdown-menu p-3 shadow theme-card theme-border" aria-labelledby="groupFilterBtn" style="min-width: 250px;">
            <div class="d-flex justify-content-between mb-2 border-bottom theme-border pb-1">
                <div class="d-flex justify-content-between mb-2 w-100">
                    <button class="btn btn-sm btn-link text-decoration-none js-group-all">Alle</button> 
                    <button class="btn btn-sm btn-link text-decoration-none js-group-none">Keine</button>
                </div>
            </div>
            <div id="group-checkbox-container" style="max-height: 300px; overflow-y: auto;"></div>
        </ul>
    </div>

    {# C) ACTION BUTTONS #}
    <div class="d-flex gap-2 ms-3">
        {# DRUCKEN #}
        <a id="btn-print-groupcard" 
           href="{{ path('print_groupcard', {'examId': exam.id, 'class': app.request.query.get('class')}) }}" 
           class="btn btn-outline-secondary btn-sm d-flex align-items-center theme-text" target="_blank" title="Drucken">
            <i class="bi bi-printer"></i> <span class="ms-2 d-none d-md-inline">{{ 'Drucken'|trans }}</span>
        </a>

        {# ZUR√úCK #}
        <a href="{{ path('app_exams_dashboard') }}" 
           class="btn btn-outline-secondary btn-sm d-flex align-items-center theme-text" title="Zur√ºck">
            <i class="bi bi-arrow-left"></i> <span class="ms-2 d-none d-md-inline">{{ 'Zur√ºck'|trans }}</span>
        </a>
    </div>

    {# D) SUCHLEISTE #}
    <div class="d-flex align-items-center flex-grow-1 search-container ms-2">
        <div class="input-group input-group-sm">
            <input type="text" id="client-search-input" class="form-control form-control-osa theme-bg-light theme-text theme-border" placeholder="Teilnehmer suchen...">
        </div>
    </div>        
</div>

    {# --- 3. TABELLE --- #}
    <form id="autosave-form" 
      data-discipline-route="{{ path('exam_discipline_save') }}"
      data-result-route="{{ path('exam_result_save') }}"
      data-swimming-route="{{ path('results_exam_swimming_add_proof') }}"
      data-swimming-delete-route="{{ path('results_exam_swimming_remove_proof') }}"
      data-global-token="{{ csrf_token('autosave') }}">

        <div class="table-responsive">
            <table class="table table-sm table-bordered theme-border table-results-compact align-middle table-hover">
                <thead class="theme-bg-light theme-heading text-center align-middle sticky-header">
                    <tr>
                        {# TEILNEHMER SPALTE #}
                        <th class="col-name text-start shadow-sm col-sticky-left theme-bg-light">
                            {% set currentSort = app.request.query.get('sort', 'lastname') %}
                            {% set currentOrder = app.request.query.get('order', 'asc') %}
                            {% set nextOrder = (currentSort == 'lastname' and currentOrder == 'asc') ? 'desc' : 'asc' %}
                            
                            <a href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({'id': exam.id, 'sort': 'lastname', 'order': nextOrder})) }}" 
                            class="sort-header d-flex justify-content-between align-items-center theme-heading text-decoration-none">
                                <span>Teilnehmer</span>
                                <span><i class="bi bi-filter"></i></span>
                            </a>
                        </th>

                        {# SCHWIMM SPALTE #}
                        <th class="col-swimming text-center col-discipline col-cat-SWIMMING theme-bg-light">üèä</th>

                        {# DISZIPLINEN SPALTEN #}
                        {% for category in disciplines|keys %}
                            {% if category|upper not in ['SWIMMING', 'SCHWIMMEN'] %}
                                <th class="col-discipline col-cat-{{ category }} theme-bg-light">{{ category }}</th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="theme-card">
                {% for p in participants %}
                    {% set epResults = results[p.ep_id] ?? {} %}
                    <tr data-ep-id="{{ p.ep_id }}" 
                        id="row-{{ p.ep_id }}" 
                        class="participant-row" 
                        data-class="{{ p.klasse|default('') }}"
                        data-group="{{ p.group|default('') }}">

                        {# 1. TEILNEHMER INFOS #}
                        <td class="col-name py-2 shadow-sm col-sticky-left theme-card">
                            <div class="name-container text-truncate ps-1">
                                <div class="name-main text-truncate theme-heading fw-bold">
                                    {{ p.nachname }}<span class="fw-normal theme-text">, {{ p.vorname }}</span>
                                </div>
                                
                                <div class="name-age text-truncate mb-2 theme-muted small">
                                    {{ p.klasse|default(p.group)|default('-') }} | {{ p.age_year }} J.
                                </div>

                                <div class="d-flex gap-2 align-items-center">
                                    {# Punkte Badge #}
                                    <div class="result-badge-box theme-bg-light theme-border" title="Gesamtpunkte">
                                        <div class="badge-label-small theme-muted">Pkt</div>
                                        <div class="fw-bold fs-6 theme-heading" id="total-points-{{ p.ep_id }}">{{ p.total_points|default(0) }}</div>
                                    </div>
                                    
                                    {# Medaille Badge #}
                                    {% set medalValue = p.final_medal|default('none')|lower %}
                                    {% set medalLabel = (medalValue == 'gold') ? 'Gold' : ((medalValue in ['silver','silber']) ? 'Silber' : ((medalValue == 'bronze') ? 'Bronze' : '-')) %}
                                    {% set medalClass = 'theme-bg-light theme-muted theme-border' %}
                                    
                                    {% if medalValue == 'gold' %}
                                        {% set medalClass = 'bg-gold-transparent' %}
                                    {% elseif medalValue in ['silver','silber'] %}
                                        {% set medalClass = 'bg-silver-transparent' %}
                                    {% elseif medalValue == 'bronze' %}
                                        {% set medalClass = 'bg-bronze-transparent' %} 
                                    {% endif %}

                                    <div class="result-badge-box js-medal-badge {{ medalClass }}" id="final-medal-{{ p.ep_id }}">
                                        <div class="badge-label-small text-uppercase opacity-75">Rang</div>
                                        <div class="d-flex align-items-center justify-content-center gap-1">
                                            <div class="fw-bold fs-6 js-medal-label">{{ medalLabel }}</div>
                                        </div>
                                    </div>
                                </div>    
                            </div>
                        </td>

                        {# 2. SCHWIMMEN #}
                        <td class="col-swimming align-middle p-2 text-center col-discipline col-cat-SWIMMING theme-card">
                           {# ... (Der Rest der Schwimm-Logik bleibt absolut identisch, da hier keine problematischen CSS Klassen drin sind) ... #}
                           {# Um den Codeblock nicht unn√∂tig aufzubl√§hen, habe ich die Logik hier im Beispiel ausgeblendet, du kannst sie 1:1 √ºbernehmen #}
                        </td>

                        {# 3. DISZIPLINEN #}
                        {% for category, items in disciplines %}
                            {% if category|upper not in ['SWIMMING', 'SCHWIMMEN'] %}
                                <td class="p-1 col-discipline col-cat-{{ category }} align-middle theme-card">
                                    <div class="d-flex flex-column h-100 justify-content-center">
                                        {# ... (Filter Logic bleibt identisch) ... #}
                                        
                                        {# Select #}
                                        <select class="discipline-selector js-discipline-select mb-1 form-select form-select-sm {{ mClass }} theme-bg-light theme-text theme-border" 
                                                data-save data-ep-id="{{ p.ep_id }}" data-type="discipline" data-kategorie="{{ category }}">
                                                {# ... Optionen ... #}
                                        </select>

                                        {# Input #}
                                        <input type="text" class="form-control form-control-custom fw-bold {{ mClass }} theme-bg-light theme-text theme-border"
                                               value="{{ resObj ? resObj.leistung : '' }}"
                                               {{ isNoneUnit ? 'disabled' : '' }}
                                               placeholder="{{ isNoneUnit ? '‚úì' : '' }}"
                                               data-save data-ep-id="{{ p.ep_id }}" data-type="leistung" data-kategorie="{{ category }}">

                                        {# Hint #}
                                        <div class="req-hint theme-muted">
                                            {# ... Hint Logic ... #}
                                        </div>
                                    </div>
                                </td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>
{% endblock %}